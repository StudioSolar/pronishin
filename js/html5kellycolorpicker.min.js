/*
 2015 Rubchuk Vladimir
 @license   GPLv3
 @version   0.8
*/
function KellyColorPicker(X){function Y(){var a={};a.size;a.padding=2;a.path;a.imageData=null;a.dotToSv=function(a){return{s:Math.abs(this.path[3].x-a.x)/this.size,v:Math.abs(this.path[3].y-a.y)/this.size}};a.svToDot=function(a){var b=this.path[0].x,f=this.path[0].y,d=.02;100>u&&(d=.07);for(var e=0;e<this.size;e++)for(var k=0;k<this.size;k++){var h={x:k+b,y:e+f},g=this.dotToSv(h),l=Math.abs(g.s-a.s),g=Math.abs(g.v-a.v);if(l<d&&g<d)return h}return{x:0,y:0}};a.limitDotPosition=function(a){var b=a.x;
a=a.y;b<this.path[0].x&&(b=this.path[0].x);b>this.path[0].x+this.size&&(b=this.path[0].x+this.size);a<this.path[0].y&&(a=this.path[0].y);a>this.path[0].y+this.size&&(a=this.path[0].y+this.size);return{x:b,y:a}};a.draw=function(){this.imageData||(this.imageData=d.createImageData(this.size,this.size));for(var a=0,b=this.path[0].x,f=this.path[0].y,e=0;e<this.size;e++)for(var L=0;L<this.size;L++){var k=this.dotToSv({x:L+b,y:e+f}),k=I(h.h,k.s,k.v);this.imageData.data[a+0]=k.r;this.imageData.data[a+1]=
k.g;this.imageData.data[a+2]=k.b;this.imageData.data[a+3]=255;a+=4}d.putImageData(this.imageData,b,f);d.beginPath();d.strokeStyle="rgba(0,0,0, 0.2)";d.lineWidth=2;for(a=0;a<=this.path.length-1;++a)0==a?d.moveTo(this.path[a].x,this.path[a].y):d.lineTo(this.path[a].x,this.path[a].y);d.stroke();d.closePath()};a.updateSize=function(){this.size=Math.floor((2*e.innerRadius-2*n.paddingX-2*this.padding)/Math.sqrt(2));this.path=[];this.path[0]={x:this.size/2*-1,y:this.size/2*-1};this.path[1]={x:this.path[0].x+
this.size,y:this.path[0].y};this.path[2]={x:this.path[1].x,y:this.path[1].y+this.size};this.path[3]={x:this.path[2].x-this.size,y:this.path[2].y};this.path[4]={x:this.path[0].x,y:this.path[0].y};for(var a=0;a<=this.path.length-1;++a)this.path[a].x+=e.pos.x,this.path[a].y+=e.pos.y};a.isDotIn=function(a){return a.x<this.path[0].x||a.x>this.path[0].x+this.size||a.y<this.path[0].y||a.y>this.path[0].y+this.size?!1:!0};return a}function Z(){var a={};a.size;a.padding=2;a.path;a.imageData=null;a.followWheel=
!0;a.s;a.sOnTop=!1;a.outerRadius;a.limitDotPosition=function(a){var b=a.x;a=a.y;var f=this.path[0].x,d=this.path[2].x,e=a,f=Math.min(Math.max(d,b),f),k=(this.path[0].y-this.path[1].y)/(this.path[0].x-this.path[1].x),h=Math.ceil(this.path[1].y+k*(f-this.path[1].x)),k=(this.path[0].y-this.path[2].y)/(this.path[0].x-this.path[2].x),k=Math.floor(this.path[2].y+k*(f-this.path[2].x));b<d&&(e=a);e=Math.min(Math.max(h,e),k);return{x:f,y:e}};a.svToDot=function(a){var b=.02;100>u&&(b=.07);for(var f=0;f<this.size;f++)for(var d=
0;d<this.size;d++){var e={x:this.path[1].x+d,y:this.path[1].y+f};if(q.isDotIn(e)){var k=this.dotToSv(e),h=Math.abs(k.s-a.s),k=Math.abs(k.v-a.v);if(h<b&&k<b)return e}}return{x:0,y:0}};a.draw=function(){this.imageData||(this.imageData=A.createImageData(this.size,this.size));x.width=this.size;x.height=this.size;for(var a=this.path[1].x,b=this.path[1].y,f=0,e=0;e<this.size;e++)for(var g=0;g<this.size;g++){var k={x:this.path[1].x+g,y:this.path[1].y+e};q.isDotIn(k)?(k=this.dotToSv(k),k=I(h.h,k.s,k.v),this.imageData.data[f+
0]=k.r,this.imageData.data[f+1]=k.g,this.imageData.data[f+2]=k.b,this.imageData.data[f+3]=255):(this.imageData.data[f+0]=0,this.imageData.data[f+1]=0,this.imageData.data[f+2]=0,this.imageData.data[f+3]=0);f+=4}A.putImageData(this.imageData,0,0);d.drawImage(x,a,b);d.beginPath();d.strokeStyle="rgba(0, 0, 0, 0.3)";d.lineWidth=2;a=this.path;for(f=0;f<=a.length-1;++f)0==f?d.moveTo(a[f].x,a[f].y):d.lineTo(a[f].x,a[f].y);d.stroke();d.closePath()};a.calcS=function(a){return Math.abs((a[1].x-a[0].x)*(a[2].y-
a[0].y)-(a[2].x-a[0].x)*(a[1].y-a[0].y))/2};a.dotToSv=function(a){var b=this.vol,f=((a.x-b[0].x)*(b[1].x-b[0].x)+(a.y-b[0].y)*(b[1].y-b[0].y))/((b[0].x-b[1].x)*(b[0].x-b[1].x)+(b[0].y-b[1].y)*(b[0].y-b[1].y));0>f&&(f=0);1<f&&(f=1);var d=b[0].y+f*(b[1].y-b[0].y),e=this.vol[0],b=Math.sqrt(Math.pow(b[0].x+f*(b[1].x-b[0].x)-e.x,2)+Math.pow(d-e.y,2));1>b&&(b=Math.floor(b));b>this.h-1&&(b=this.h);b/=this.h;a=Math.abs(Q(a,this.sSide));30>a&&(a=30);a=60-(a-30);a/=60;return{s:a,v:b}};a.isDotIn=function(a){a=
[{x:this.path[0].x,y:this.path[0].y},{x:this.path[1].x,y:this.path[1].y},{x:a.x,y:a.y}];var b=this.calcS(a);a[1]={x:this.path[2].x,y:this.path[2].y};b+=this.calcS(a);a[0]={x:this.path[1].x,y:this.path[1].y};b+=this.calcS(a);return Math.ceil(b)==Math.ceil(this.s)?!0:!1};a.updateSize=function(){this.outerRadius=e.innerRadius-n.paddingX-this.padding;this.size=Math.floor(2*this.outerRadius*Math.sin(C/180*60));var a=Math.sqrt(3)/2*this.size;this.h=Math.sqrt(3)/2*this.size;this.path=[];this.path[0]={x:this.outerRadius,
y:0};this.path[1]={x:this.path[0].x-a,y:this.size/2*-1};this.path[2]={x:this.path[1].x,y:this.size/2};this.path[3]={x:this.path[0].x,y:this.path[0].y};for(a=0;a<=this.path.length-1;++a)this.path[a].x+=e.pos.x,this.path[a].y+=e.pos.y;this.vol=[];this.s=this.calcS(this.path);this.sOnTop?(a=R(this.path[0],this.path[2]),this.vol[0]={x:this.path[1].x,y:this.path[1].y},this.vol[1]={x:a.x,y:a.y},this.sSide=this.path[1]):(a=R(this.path[0],this.path[1]),this.vol[0]={x:this.path[2].x,y:this.path[2].y},this.vol[1]=
{x:a.x,y:a.y},this.sSide=this.path[2])};return a}function r(a,c,b){"object"!==typeof a&&(a=document.getElementById(a));if(!a)return!1;F[c]=b;a.addEventListener?a.addEventListener(c,F[c]):a.attachEvent("on"+c,F[c]);return!0}function p(a,c){"object"!==typeof a&&(a=document.getElementById(a));if(!a||!F[c])return!1;a.removeEventListener?a.removeEventListener(c,F[c]):a.detachEvent("on"+c,F[c]);F[c]=null;return!0}function I(a,c,b){var f,d,e,k,h,g;a&&void 0===c&&void 0===b&&(c=a.s,b=a.v,a=a.h);k=Math.floor(6*
a);h=6*a-k;a=b*(1-c);g=b*(1-h*c);c=b*(1-(1-h)*c);switch(k%6){case 0:f=b;d=c;e=a;break;case 1:f=g;d=b;e=a;break;case 2:f=a;d=b;e=c;break;case 3:f=a;d=g;e=b;break;case 4:f=c;d=a;e=b;break;case 5:f=b,d=a,e=g}return{r:Math.floor(255*f),g:Math.floor(255*d),b:Math.floor(255*e)}}function S(a){var c=function(a){a=a.toString(16);return 1===a.length?"0"+a:a};return"#"+c(a.r)+c(a.g)+c(a.b)}function R(a,c){return{x:(a.x+c.x)/2,y:(a.y+c.y)/2}}function Q(a,c,b){c||(c={x:0,y:0});a=180*Math.atan2(a.y-c.y,a.x-c.x)/
C;b&&0>a&&(a=360+a);return a}function M(){T=2+n.paddingX;D=!1;e.imageData=null;v=u/2;e.pos={x:v,y:v};e.outerRadius=v-T;e.innerRadius=e.outerRadius-e.width;n.path=[{x:e.innerRadius-n.paddingX,y:-1*n.height},{x:e.outerRadius+n.paddingX,y:-1*n.height},{x:e.outerRadius+n.paddingX,y:n.height},{x:e.innerRadius-n.paddingX,y:n.height},{x:e.innerRadius-n.paddingX,y:-1*n.height}];for(var a=0;a<=n.path.length-1;++a);"CANVAS"!=w.tagName&&(w.style.width=u+"px",w.style.height=u+"px");g.width=u;g.height=u;q.updateSize()}
function N(){B&&(B.value=y,U&&(B.style.color=.5>h.v?"#FFF":"#000",B.style.background=y))}function aa(){if(!w)return!1;"CANVAS"!=w.tagName?(g=document.createElement("CANVAS"),w.appendChild(g)):g=w;"undefined"!=typeof window.G_vmlCanvasManager&&(g=window.G_vmlCanvasManager.initElement(g),x=window.G_vmlCanvasManager.initElement(x));return g.getContext&&g.getContext("2d")?(d=g.getContext("2d"),A=x.getContext("2d"),!0):!1}function O(){r(g,"mousedown",function(a){l.mouseDownEvent(a)});r(g,"touchstart",
function(a){l.mouseDownEvent(a)});r(g,"mouseout",function(a){l.mouseOutEvent(a)});r(window,"touchmove",function(a){l.touchMoveEvent(a)});r(g,"mousemove",function(a){l.mouseMoveRest(a)})}function V(){p(g,"mousedown");p(g,"touchstart");p(g,"mouseout");p(window,"touchmove");p(g,"mousemove")}function H(a){a=a||window.event;var c,b=document.body.scrollLeft+document.documentElement.scrollLeft,d=document.body.scrollTop+document.documentElement.scrollTop;a.touches?(c=a.touches[0].clientX+b,a=a.touches[0].clientY+
d):(c=a.clientX+b,a=a.clientY+d);var e=g.getBoundingClientRect();c-=e.left+b;a-=e.top+d;return{x:c,y:a}}function ba(){if(!d)return!1;if(D)return d.putImageData(J,0,0),!0;d.clearRect(0,0,u,u);if(e.imageData)d.putImageData(e.imageData,0,0);else{for(var a=e.startAngle,c=0;360>=c;c++){var b=C/180*(c-2),f=C/180*c;d.beginPath();d.moveTo(v,v);d.arc(v,v,e.outerRadius,b,f,!1);d.closePath();b=I(a/360,1,1);d.fillStyle="rgb("+b.r+", "+b.g+", "+b.b+")";d.fill();a++;360<=a&&(a=0)}d.globalCompositeOperation="destination-out";
d.beginPath();d.arc(v,v,e.innerRadius,0,2*C);d.fill();d.globalCompositeOperation="source-over";d.strokeStyle=e.innerStrokeStyle;d.lineWidth=2;d.stroke();d.closePath();d.beginPath();d.arc(v,v,e.outerRadius,0,2*C);d.strokeStyle=e.outerStrokeStyle;d.lineWidth=2;d.stroke();d.closePath();e.imageData=d.getImageData(0,0,g.width,g.height)}q.draw();t||(J=d.getImageData(0,0,g.width,g.height),D=!0);return!0}function K(){if(!ba())return!1;var a=360*h.h-e.startAngle;d.beginPath();var c=n.path,b;b=C/180*a;for(var a=
[],f=0;f<=c.length-1;++f)a[f]={x:c[f].x*Math.cos(b)-c[f].y*Math.sin(b),y:c[f].x*Math.sin(b)+c[f].y*Math.cos(b)};for(c=0;c<=a.length-1;++c)a[c].x+=e.pos.x,a[c].y+=e.pos.y,0==c?d.moveTo(a[c].x,a[c].y):d.lineTo(a[c].x,a[c].y);d.strokeStyle="rgba(0,0,0,0.8)";d.lineWidth=n.lineWeight;d.stroke();d.closePath();d.strokeStyle=.5<h.v&&.5>h.s?"rgba(0, 0, 0, 1)":"rgba(255, 255, 255, 1)";d.beginPath();d.lineWidth=2;d.arc(h.x,h.y,W.radius,0,2*C);d.stroke();d.closePath();return!1}var C=Math.PI,q,W={radius:4},g=
!1,d=!1,P="quad",t=!1,E=!0,F=[],m=[],x=document.createElement("canvas"),A=!1,D=!1,J=null,B=!1,U=!0,w=!1,l=this,T,u=200,v,h,G,y="#000000",e={width:18,imageData:null};e.innerRadius;e.startAngle=0;e.outerRadius;e.outerStrokeStyle="rgba(0,0,0,0.2)";e.innerStrokeStyle="rgba(0,0,0,0.2)";e.pos;e.isDotIn=function(a){return Math.pow(e.pos.x-a.x,2)+Math.pow(e.pos.y-a.y,2)<Math.pow(e.outerRadius,2)&&Math.pow(e.pos.x-a.x,2)+Math.pow(e.pos.y-a.y,2)>Math.pow(e.innerRadius,2)?!0:!1};var n={lineWeight:2,height:4,
paddingX:2};n.path;var z={svCursorData:null,stCursor:null,curType:0,size:16,initSvCursor:function(){if(!g)return!1;var a=document.body;this.curType=1;this.stCursor||(this.stCursor=a.style.cursor);this.stCursor||(this.stCursor="auto");if(this.svCursorData)return a.style.cursor=this.svCursorData,!0;if(!x)return!1;x.width=this.size;x.height=this.size;A.clearRect(0,0,this.size,this.size);A.strokeStyle="rgba(255, 255, 255, 1)";A.beginPath();A.lineWidth=2;A.arc(this.size/2,this.size/2,this.size/2,0,2*C);
A.stroke();A.closePath();var c=z.size,b=x.toDataURL();this.svCursorData="url("+b+") "+c/2+" "+c/2+", auto";if(!this.svCursorData)return!1;a.style.cursor=this.svCursorData;-1===a.style.cursor.indexOf(b)&&(this.svCursorData="crosshair",a.style.cursor="crosshair");return!0},initStandartCursor:function(){this.stCursor&&(z.curType=0,document.body.style.cursor=this.stCursor)},updateCursor:function(a){KellyColorPicker.cursorLock||(q.isDotIn(a)?z.initSvCursor():z.initStandartCursor())}};this.setHueByDot=
function(a){a=Q(a,e.pos)+e.startAngle;0>a&&(a=360+a);h.h=a/360;G=I(h.h,h.s,h.v);y=S(G);m.change&&(0,m.change)(l);N();D=!1;K()};this.setColorByHex=function(a){if(a&&a.length&&("#"!=a.charAt(0)&&(a="#"+a),7==a.length&&a.match(/^#([0-9A-F]){3}$|^#([0-9A-F]){6}$/img)&&(!y||a!=y||!D))){var c=a,c=parseInt("#"==c.charAt(0)?c.slice(1):c,16);G={r:c>>16,g:c>>8&255,b:c&255};y=a;a=G;var b=c=void 0;a&&void 0===c&&void 0===b&&(c=a.g,b=a.b,a=a.r);a/=255;var c=c/255,b=b/255,d=Math.max(a,c,b),e=Math.min(a,c,b),g,
k=d-e;if(d==e)g=0;else{switch(d){case a:g=(c-b)/k+(c<b?6:0);break;case c:g=(b-a)/k+2;break;case b:g=(a-c)/k+4}g/=6}h={h:g,s:0==d?0:k/d,v:d};g=q.svToDot(h);h.x=g.x;h.y=g.y;D=!1;K();m.change&&(0,m.change)(l);N()}};this.setColorByDot=function(a){var c=q.dotToSv(a);h.s=c.s;h.v=c.v;h.x=a.x;h.y=a.y;1<h.s&&(h.s=1);0>h.s&&(h.s=0);1<h.v&&(h.v=1);0>h.v&&(h.v=0);G=I(h.h,h.s,h.v);y=S(G);m.change&&(0,m.change)(l);N();K()};this.mouseOutEvent=function(a){0<z.curType&&!KellyColorPicker.cursorLock&&z.initStandartCursor()};
this.mouseMoveRest=function(a){if(!t&&E){E=!1;var c=H(a);z.updateCursor(c);requestAnimationFrame(function(){E=!0});m.mousemoverest&&(0,m.mousemoverest)(a,l,c)}};this.touchMoveEvent=function(a){t&&event.preventDefault()};this.mouseDownEvent=function(a){a.preventDefault();var c,b=!1,d=H(a);e.isDotIn(d)?(t="wheel",l.setHueByDot(d),c=function(a){l.wheelMouseMove(a,d)},b=function(a){KellyColorPicker.cursorLock=!1;l.wheelMouseUp(a,d)}):q.isDotIn(d)&&(t="sv",l.setColorByDot(d),c=function(a){l.SvMouseMove(a,
d)},b=function(a){KellyColorPicker.cursorLock=!1;l.SvMouseUp(a,d)});c&&b&&(V(),KellyColorPicker.cursorLock=!0,r(document,"mouseup",b),r(document,"mousemove",c),r(document,"touchend",b),r(document,"touchmove",c))};this.wheelMouseMove=function(a,c){a.preventDefault();if(t&&E){E=!1;var b=H(a);requestAnimationFrame(function(){E=!0});l.setHueByDot(b);m.mousemoveh&&(0,m.mousemoveh)(a,l,b)}};this.wheelMouseUp=function(a,c){a.preventDefault();if(t){p(document,"mouseup");p(document,"mousemove");p(document,
"touchend");p(document,"touchmove");O();D=t=!1;K();var b=H(a);z.updateCursor(b);m.mouseuph&&(0,m.mouseuph)(a,l,b)}};this.SvMouseMove=function(a,c){a.preventDefault();if(t&&E){E=!1;var b=H(a),b=q.limitDotPosition(b);requestAnimationFrame(function(){E=!0});l.setColorByDot(b);m.mousemovesv&&(0,m.mousemovesv)(a,l,b)}};this.SvMouseUp=function(a,c){a.preventDefault();if(t){p(document,"mouseup");p(document,"mousemove");p(document,"touchend");p(document,"touchmove");O();t=!1;var b=H(a);z.updateCursor(b);
m.mouseupsv&&(0,m.mouseupsv)(a,l,b)}};this.addUserEvent=function(a,c){m[a]=c;return!0};this.removeUserEvent=function(a){if(!m[a])return!1;m[a]=null;return!0};this.getCanvas=function(){return d?g:!1};this.getCtx=function(){return d?d:!1};this.getInput=function(){return B};this.getSvFig=function(){return q};this.getSvFigCursor=function(){return W};this.getWheel=function(){return e};this.getWheelCursor=function(){return n};this.getCurColorHsv=function(){return h};this.getCurColorRgb=function(){return G};
this.getCurColorHex=function(){return y};this.updateView=function(a){if(!d)return!1;a&&(e.imageData=null,J=q.imageData=null);D=!1;M();K();return!0};this.resize=function(a){if(!d)return!1;if(a==u)return!0;D=!1;e.imageData=null;J=q.imageData=null;u=a;M();l.setColorByHex(y);return!1};this.destroy=function(){0<z.curType&&(KellyColorPicker.cursorLock=!1,z.initStandartCursor());t&&(p(document,"mouseup"),p(document,"mousemove"),p(document,"touchend"),p(document,"touchmove"),t=!1);e.imageData=null;x=J=q.imageData=
null;w&&w.parentNode&&w.parentNode.removeChild(w);V();l=null};(function(a){var c="",b="";a.input&&"object"!==typeof a.input&&(a.input=document.getElementById(a.input));void 0!==a.input_color&&(U=a.input_color);if(a.input){B=a.input;var d=function(a){a=a||window.event;a.target||(a.target=a.srcElement);l.setColorByHex(a.target.value)};r(B,"click",d);r(B,"change",d);r(B,"keyup",d);r(B,"keypress",d)}a.userEvents&&(m=a.userEvents);a.place&&"object"!==typeof a.place&&(b=a.place,a.place=document.getElementById(a.place));
a.place?w=a.place:c+='| "place" ('+b+") not not found";a.size&&0<a.size&&(u=a.size);a.color&&(y=a.color);!a.method||"triangle"!=a.method&&"quad"!=a.method||(P=a.method);aa()||(c+=" | cant init canvas context");"quad"==P&&(q=Y());"triangle"==P&&(q=Z());c?"undefined"!==typeof console&&console.log("KellyColorPicker : "+c):O();M();l.setColorByHex(y)})(X)}KellyColorPicker.cursorLock=!1;
